services:
  # ═══════════════════════════════════════════════════════════════════════════
  # UNBOUND - Recursive DNS with Quad9 DNS-over-TLS
  # ═══════════════════════════════════════════════════════════════════════════
  unbound:
    image: mvance/unbound:latest
    container_name: unbound
    hostname: unbound
    restart: unless-stopped
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    security_opt:
      - no-new-privileges:true
    volumes:
      - ${PWD}/unbound:/opt/unbound/etc/unbound:rw
    networks:
      vpn_net:
        ipv4_address: 10.8.1.3
    healthcheck:
      test: ["CMD-SHELL", "drill @127.0.0.1 -p 5335 quad9.net || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ═══════════════════════════════════════════════════════════════════════════
  # PI-HOLE v6 - DNS Sinkhole & Ad Blocker
  # ═══════════════════════════════════════════════════════════════════════════
  pihole:
    image: pihole/pihole:latest
    container_name: pihole
    hostname: pihole
    restart: unless-stopped
    depends_on:
      unbound:
        condition: service_healthy
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
      - CHOWN
      - SETUID
      - SETGID
      - DAC_OVERRIDE
    security_opt:
      - no-new-privileges:true
    environment:
      TZ: ${TZ}
      FTLCONF_webserver_api_password: ${PIHOLE_PASSWORD}
      FTLCONF_dns_upstreams: 10.8.1.3#5335
      FTLCONF_dns_listeningMode: all
      FTLCONF_dns_dnssec: "false"
      PIHOLE_UID: ${PUID}
      PIHOLE_GID: ${PGID}
    volumes:
      - ${PWD}/pihole/etc-pihole:/etc/pihole
    networks:
      vpn_net:
        ipv4_address: 10.8.1.4
    ports:
      - "${PIHOLE_WEB_PORT:-80}:80/tcp"
      - "443:443/tcp"
    healthcheck:
      test: ["CMD-SHELL", "dig +short +norecurse +retry=0 @127.0.0.1 pi.hole || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ═══════════════════════════════════════════════════════════════════════════
  # WG-EASY - WireGuard VPN with Web UI
  # ═══════════════════════════════════════════════════════════════════════════
  wireguard:
    image: ghcr.io/wg-easy/wg-easy:latest
    container_name: wireguard
    hostname: wireguard
    restart: unless-stopped
    depends_on:
      pihole:
        condition: service_healthy
    cap_drop:
      - ALL
    cap_add:
      - NET_ADMIN
      - NET_RAW
      - SYS_MODULE
    security_opt:
      - no-new-privileges:true
    sysctls:
      - net.ipv4.conf.all.src_valid_mark=1
      - net.ipv4.ip_forward=1
      - net.ipv6.conf.all.forwarding=1
    environment:
      TZ: ${TZ}
      INIT_ENABLED: "true"
      INIT_USERNAME: ${WG_ADMIN_USER}
      INIT_PASSWORD: ${WG_ADMIN_PASSWORD}
      INIT_HOST: ${WG_HOST}
      INIT_PORT: ${WG_PORT}
      INIT_DNS: 10.8.1.4
      INIT_ALLOWED_IPS: 0.0.0.0/0,::/0
      PORT: 51821
      INSECURE: "false"
    volumes:
      - ${PWD}/wireguard:/etc/wireguard
    networks:
      vpn_net:
        ipv4_address: 10.8.1.2
    ports:
      - "${WG_PORT}:${WG_PORT}/udp"
      - "${WG_UI_PORT:-51821}:51821/tcp"
    healthcheck:
      test: ["CMD-SHELL", "wg show || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

# ═══════════════════════════════════════════════════════════════════════════════
# NETWORKS
# ═══════════════════════════════════════════════════════════════════════════════
networks:
  vpn_net:
    driver: bridge
    ipam:
      config:
        - subnet: 10.8.1.0/24
          gateway: 10.8.1.1
